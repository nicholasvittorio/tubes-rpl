<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/layout :: head('Input Nilai')}"></head>
<body class="bg-gray-100 min-h-screen">
    <!-- Inline header -->
    <header class="bg-sky-400 text-white px-6 py-4 flex items-center justify-between fixed top-0 left-0 right-0 z-40">
        <div class="flex items-center gap-4">
            <a th:href="@{/dosen/nilai/kelas/{id}/tugas(id=${kelas.idKelas})}" class="p-2 hover:bg-sky-500 rounded-lg transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                </svg>
            </a>
            <h1 class="text-xl font-semibold tracking-wide">Input Nilai - <span th:text="${komponen.namaKomponen}">Komponen</span></h1>
        </div>
        <div class="flex items-center gap-4">
            <div class="w-10 h-10 bg-white rounded-full overflow-hidden">
                <img src="/placeholder.svg?height=40&width=40" alt="Profile" class="w-full h-full object-cover">
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="pt-20 px-6 pb-8">
        <!-- Alert Messages -->
        <div th:if="${success}" class="mb-4 p-4 bg-green-100 border border-green-400 text-green-700 rounded-lg">
            <span th:text="${success}"></span>
        </div>
        <div th:if="${error}" class="mb-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg">
            <span th:text="${error}"></span>
        </div>
        
        <!-- Info -->
        <div class="bg-white rounded-2xl p-6 shadow-sm mb-6">
            <h2 class="text-lg font-semibold text-gray-800" th:text="${tugas.namaTugas}">Tugas Besar</h2>
            <p class="text-gray-600 mt-1">Komponen: <span class="font-medium" th:text="${komponen.namaKomponen}">Phase 1</span></p>
            <p class="text-gray-600">Bobot: <span class="font-medium" th:text="${komponen.bobot} + '%'">50%</span></p>
            <div th:if="${komponen.deskripsiRubrik}" class="mt-4 p-4 bg-gray-50 rounded-lg">
                <p class="text-sm text-gray-500 mb-1">Rubrik:</p>
                <p class="text-gray-700" th:text="${komponen.deskripsiRubrik}">Deskripsi rubrik</p>
            </div>
        </div>

        <!-- Added batch input nilai for all members per kelompok -->
        <!-- Kelompok Cards with Batch Input -->
        <div th:each="kelompok : ${kelompokList}" class="bg-white rounded-2xl p-6 shadow-sm mb-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-semibold text-gray-800" th:text="${kelompok.namaKelompok}">Kelompok 1</h3>
                <span class="text-sm text-gray-500" th:text="${#lists.size(kelompok.anggota)} + ' anggota'">0 anggota</span>
            </div>
            
            <div th:if="${#lists.isEmpty(kelompok.anggota)}" class="text-gray-400 text-sm py-4 text-center">
                Tidak ada anggota dalam kelompok ini
            </div>
            
            <!-- Form untuk input nilai sekaligus untuk semua anggota -->
            <form th:if="${!#lists.isEmpty(kelompok.anggota)}" 
                  th:action="@{/dosen/nilai/komponen/{id}/batch(id=${komponen.idKomponen})}" 
                  method="post" class="space-y-4">
                
                <input type="hidden" name="idKelompok" th:value="${kelompok.idKelompok}">
                
                <!-- Input nilai sama untuk semua anggota kelompok -->
                <div class="bg-sky-50 rounded-xl p-4 mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Input Nilai untuk Semua Anggota Kelompok
                    </label>
                    <div class="flex flex-wrap gap-4 items-end">
                        <div class="flex-1 min-w-[120px]">
                            <label class="block text-xs text-gray-500 mb-1">Nilai (0-100)</label>
                            <input type="number" name="nilaiAngka" 
                                   min="0" max="100" step="0.1" required placeholder="Masukkan nilai"
                                   class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-sky-400 outline-none">
                        </div>
                        <div class="flex-[2] min-w-[200px]">
                            <label class="block text-xs text-gray-500 mb-1">Catatan (opsional)</label>
                            <input type="text" name="catatan" placeholder="Catatan untuk kelompok"
                                   class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-sky-400 outline-none">
                        </div>
                        <button type="submit" 
                                class="bg-sky-500 text-white px-6 py-2 rounded-lg hover:bg-sky-600 transition-colors font-medium">
                            Simpan Nilai Kelompok
                        </button>
                    </div>
                </div>
                
                <!-- List anggota dengan nilai saat ini -->
                <div class="border rounded-xl overflow-hidden">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-600">Nama Mahasiswa</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-600">NPM</th>
                                <th class="px-4 py-3 text-center text-sm font-medium text-gray-600">Nilai Saat Ini</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-600">Catatan</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y">
                            <tr th:each="anggota : ${kelompok.anggota}" class="hover:bg-gray-50">
                                <td class="px-4 py-3">
                                    <span class="font-medium text-gray-800" 
                                          th:text="${anggota.pengguna != null ? anggota.pengguna.namaLengkap : 'Mahasiswa'}">Nama</span>
                                </td>
                                <td class="px-4 py-3 text-gray-600" th:text="${anggota.npm}">NPM</td>
                                <td class="px-4 py-3 text-center">
                                    <span th:if="${anggota.nilai != null}" 
                                          class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium"
                                          th:classappend="${anggota.nilai.nilaiAngka >= 80 ? 'bg-green-100 text-green-800' : (anggota.nilai.nilaiAngka >= 60 ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800')}"
                                          th:text="${anggota.nilai.nilaiAngka}">85</span>
                                    <span th:if="${anggota.nilai == null}" class="text-gray-400 text-sm">Belum dinilai</span>
                                </td>
                                <td class="px-4 py-3 text-gray-500 text-sm" 
                                    th:text="${anggota.nilai != null && anggota.nilai.catatan != null ? anggota.nilai.catatan : '-'}">-</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </form>
            
            <!-- Individual edit section -->
            <details th:if="${!#lists.isEmpty(kelompok.anggota)}" class="mt-4">
                <summary class="cursor-pointer text-sm text-sky-600 hover:text-sky-700 font-medium">
                    Edit nilai individual per mahasiswa
                </summary>
                <div class="mt-4 space-y-3 pl-4 border-l-2 border-sky-200">
                    <div th:each="anggota : ${kelompok.anggota}" class="flex items-center gap-4 py-2">
                        <div class="flex-1">
                            <span class="font-medium text-gray-700" 
                                  th:text="${anggota.pengguna != null ? anggota.pengguna.namaLengkap : anggota.npm}">Nama</span>
                        </div>
                        <form th:action="@{/dosen/nilai/komponen/{id}/input(id=${komponen.idKomponen})}" 
                              method="post" class="flex items-center gap-2">
                            <input type="hidden" name="npm" th:value="${anggota.npm}">
                            <input type="hidden" name="idKelompok" th:value="${kelompok.idKelompok}">
                            <input type="number" name="nilaiAngka" th:value="${anggota.nilai?.nilaiAngka}" 
                                   min="0" max="100" step="0.1" required placeholder="Nilai"
                                   class="w-20 px-3 py-1.5 border rounded-lg text-center text-sm focus:ring-2 focus:ring-sky-400 outline-none">
                            <input type="text" name="catatan" th:value="${anggota.nilai?.catatan}" placeholder="Catatan"
                                   class="w-32 px-3 py-1.5 border rounded-lg text-sm focus:ring-2 focus:ring-sky-400 outline-none">
                            <button type="submit" class="bg-gray-100 text-gray-700 px-3 py-1.5 rounded-lg hover:bg-gray-200 transition-colors text-sm">
                                Simpan
                            </button>
                        </form>
                    </div>
                </div>
            </details>
        </div>
        
        <!-- Empty state -->
        <div th:if="${#lists.isEmpty(kelompokList)}" class="text-center py-12 bg-white rounded-2xl">
            <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
            </svg>
            <p class="text-gray-500">Belum ada kelompok di kelas ini</p>
        </div>
    </main>
</body>
</html>
